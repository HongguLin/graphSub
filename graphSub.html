<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-COMPATIBLE" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>graphSub</title>
    <link rel="stylesheet" href="css/base.css">
    <title>Animating Changes in Force Diagram</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="static/js/graphSub.js" charset="utf-8"></script>
    <style>
        .link {
            stroke: #2E2E2E;
            stroke-width: 2px;
        }

        .node {
            stroke: #fff;
            stroke-width: 2px;
        }
        .textClass {
            stroke: #323232;
            font-family: "Lucida Grande", "Droid Sans", Arial, Helvetica, sans-serif;
            font-weight: normal;
            stroke-width: .5;
            font-size: 14px;
        }
    </style>
</head>
<body>
<button onclick="reStart()">Restart Animation</button>
<script>
    // add a method conditionaly
    if (!('xpush' in Array.prototype)) {
        // push value to array only if not already present
        Array.prototype.xpush = function(value){
            if(this.indexOf(value) === -1){
                this.push(value);
            };
            return this
        };
    }
    
    d3.json("data/miserables.json", function(error, jsonData) {
        if (error) throw error;
        // Code layout uses the functional/module pattern
        // See p52 of Crockfords book
        function chart(elementName) {
            var width = 960, // default width
                height = 450, // default height
                color = d3.scale.category10(),
                force = d3.layout.force(),
                nodes = force.nodes(),
                links = force.links(),
                graph = jsonData,
                vis,
                runOnceFlag = true;
   
            vis = d3.select(elementName)
                    .append("svg:svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("id", "svg")
                    .attr("pointer-events", "all")
                    .attr("viewBox", "0 0 " + width + " " + height)
                    .attr("perserveAspectRatio", "xMinYMid")
                    .append('svg:g');

            if (runOnceFlag) {
                clickHandler(graph.nodes[0], 0);
                runOnceFlag = false;
            };
            
            function width(value) {
                if (!arguments.length) return width;
                width = value;
                return chart;
            };

            function height(value) {
                if (!arguments.length) return height;
                height = value;
                return chart;
            };

            // add nodes to the layout
            function addNode(nodeObj){
                nodes.push(nodeObj);
                update();
            };

            function addLink(source, target, value){
                var link = {"source": findNode(source), "target": findNode(target), "value": value};
                links.push(link);
                //console.log(link);
                update();
            };

            // look for the node in the d3 layout
            function findNode(name) {
                for (var i in nodes) {
                    if (nodes[i]["name"] === name) return nodes[i];
                };
            };

            // remove all links form the layout
            function removeAllLinks() {
                links.splice(0, links.length);
                update();
            };

            // remove all node from the layout
            function removeAllNodes() {
                nodes.splice(0, nodes.length);
                update();
            };

            function findNodeIndex(name, nodes) {
                for (var i = 0; i < graph.nodes.length; i++) {
                    if (graph.nodes[i].name == name) {
                        return i;
                    }
                };
            };

            function getSubNetwork(datum, hops){
                // return all the nodes within the number of 'hops'
                // initialise variable.

                // chosen to return indice values rarther than actual object
                // to avoid hidden references to objects tainting the layout data
                var count = 0,
                    toVisit = [], // nodes Indices to look for
                    subNodes = [],// list of node indices
                    subLinks = [],// list of source target indices
                    currentIndex,
                    links = graph.links
                    nodes = graph.nodes;

                // initialize
                console.log('datum.name', datum.name, nodes);
                currentIndex = findNodeIndex(datum.name, nodes); // index of the node
                if (currentIndex === undefined) throw error;

                toVisit.push(currentIndex); // next node to find
                subNodes.push(currentIndex); // nodes in the sub network

                // working with raw data from JSON file
                while((count < hops) || (toVisit.length === 0)){
                    currentIndex = toVisit.pop(toVisit);

                    for (var i = 0; i < links.length; i++) {
                        // collect links that 'currentIndex' points to
                        if(links[i].source === currentIndex){
                            
                            subLinks.xpush({sourceIndex: currentIndex, targetIndex: links[i].target}); 
                            toVisit.xpush(links[i].target);
                            subNodes.xpush(links[i].target);
                        };
                  
                        // collect the links that point to 'currentIndex'
                        if(links[i].target === currentIndex){
                            
                            subLinks.xpush({sourceIndex: links[i].source, targetIndex: currentIndex}); 
                            toVisit.xpush(links[i].source);
                            subNodes.xpush(links[i].source);
                        };
                    };
                    count = count + 1;
                };
                console.log('subNodes', subNodes);
                console.log('subLinks', subLinks);

                return {
                    'subNodes': subNodes,
                    'subLinks': subLinks
                };
            };

            function clickHandler(d, i){
                // clear the nodes and links array
                removeAllNodes();
                console.log('layout nodes', nodes);
                removeAllLinks();
                console.log('layout links', links);
                var link,
                    source,
                    target;

                // get the subNet values
                var subNet = getSubNetwork(d, 1);
                // add the nodes one at a time
                for (var i = 0; i < subNet.subNodes.length; i++) {
                    addNode(graph.nodes[subNet.subNodes[i]])
                };
                // then add the links
                for (var i = 0; i < subNet.subLinks.length; i++) {
                    link = subNet.subLinks[i];
                    // get objects from JSON data
                    source = graph.nodes[link.sourceIndex];
                    target = graph.nodes[link.targetIndex];

                    addLink(source.name, target.name, 1);
                    
                };
            };

            function update() {
                var link = vis.selectAll("line")
                        .data(links, function (d) {
                            return d.source.name + "-" + d.target.name;
                        });

                link.enter().append("line")
                        .attr("id", function (d) {
                            return d.source.name + "-" + d.target.name;
                        })
                        .attr("stroke-width", function (d) {
                            return d.value / 10;
                        })
                        .attr("class", "link");
                link.append("title")
                        .text(function (d) {
                            return d.value;
                        });
                link.exit().remove();

                var node = vis.selectAll("g.node")
                        .data(nodes, function (d) {
                            return d.id;
                        });

                var nodeEnter = node.enter().append("g")
                        .attr("class", "node")
                        .call(force.drag);

                nodeEnter.append("svg:circle")
                        .attr("r", 12)
                        .attr("id", function (d) {
                            return "Node;" + d.id;
                        })
                        .attr("class", "nodeStrokeClass")
                        .attr("fill", function(d) { return color(d.id); })
                        .on('click', clickHandler);

                nodeEnter.append("svg:text")
                        .attr("class", "textClass")
                        .attr("x", 14)
                        .attr("y", ".31em")
                        .text(function (d) {
                            return d.id;
                        });

                node.exit().remove();

                force.on("tick", function () {

                    node.attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    });

                    link.attr("x1", function (d) {
                        return d.source.x;
                    })
                            .attr("y1", function (d) {
                                return d.source.y;
                            })
                            .attr("x2", function (d) {
                                return d.target.x;
                            })
                            .attr("y2", function (d) {
                                return d.target.y;
                            });
                });

                // Restart the force layout.
                force.gravity(.01)
                    .charge(-80000)
                    .friction(0)
                    .linkDistance( function(d) { return d.value * 10 } )
                    .size([width, height])
                    .start();
                };
            };
            ///
            chart('body');
    });
</script>
</body>
</html>